# Troubleshooting

Common problem solutions when using Traceability.

## Correlation-id is not being propagated

### Possible Causes and Solutions

1. **Middleware/Handler is not configured**
   - Make sure the middleware/handler is configured correctly
   - For ASP.NET Core: Check if `AddTraceability()` was called or if `app.UseCorrelationId()` is in the pipeline
   - For .NET Framework: Check if `CorrelationIdMessageHandler` or `CorrelationIdHttpModule` is configured

2. **HttpClient is not using CorrelationIdHandler**
   - Make sure you're using `IHttpClientFactory` with `AddTraceableHttpClient()` or `.AddHttpMessageHandler<CorrelationIdHandler>()`
   - Check if `AutoConfigureHttpClient` is not disabled in options

3. **Asynchronous context is not being preserved**
   - Make sure you're not using `Task.Run()` without preserving the context
   - Use `await` correctly to preserve the asynchronous context

## Correlation-id does not appear in logs

### For Serilog

1. Use `WithTraceability("YourOrigin")` or configure `SourceEnricher` + `CorrelationIdEnricher` manually
2. Check the logger output template to include `{CorrelationId}`

**Example:**
```csharp
Log.Logger = new LoggerConfiguration()
    .WithTraceability("UserService")
    .WriteTo.Console(
        outputTemplate: "[{Timestamp:HH:mm:ss} {Level:u3}] {Source} {CorrelationId} {Message:lj}")
    .CreateLogger();
```

### For Microsoft.Extensions.Logging (.NET 8)

1. Call `AddTraceability("YourOrigin")` and enable scopes in Console (`IncludeScopes = true`)
2. Check if the logger is configured correctly

**Example:**
```csharp
builder.Services.AddTraceability("UserService");
builder.Logging.AddConsole(options => options.IncludeScopes = true);
```

## Problems with .NET Framework 4.8

### Dependencies

1. Make sure the correct versions of dependencies are installed
2. Check if all NuGet references are correct

### Web API

1. Add `CorrelationIdMessageHandler` in `Global.asax.cs`
2. Check if the handler is in the correct order in the pipeline

**Example:**
```csharp
GlobalConfiguration.Configure(config =>
{
    config.MessageHandlers.Add(new CorrelationIdMessageHandler());
    config.MapHttpAttributeRoutes();
});
```

### Traditional ASP.NET

1. Configure `CorrelationIdHttpModule` in `web.config`
2. Check if the module is registered correctly

**Example (web.config):**
```xml
<system.webServer>
  <modules>
    <add name="CorrelationIdHttpModule" 
         type="Traceability.Middleware.CorrelationIdHttpModule, Traceability" />
  </modules>
</system.webServer>
```

### Options Configuration

To configure options, use `CorrelationIdHttpModule.Configure()` or `CorrelationIdMessageHandler.Configure()` before using.

**Example:**
```csharp
CorrelationIdMessageHandler.Configure(new TraceabilityOptions
{
    HeaderName = "X-Correlation-Id",
    ValidateCorrelationIdFormat = true
});
```

## Source is not being defined

### Error: InvalidOperationException

If you receive an exception stating that Source must be provided:

1. **Provide Source explicitly:**
   ```csharp
   builder.Services.AddTraceability("UserService");
   ```

2. **Or set environment variable:**
   ```bash
   export TRACEABILITY_SERVICENAME="UserService"
   ```

3. **Or configure in options:**
   ```csharp
   builder.Services.AddTraceability(options =>
   {
       options.Source = "UserService";
   });
   ```

## HttpClient causing socket exhaustion

### Solution

Always use `IHttpClientFactory` instead of creating direct instances of `HttpClient`.

**❌ Incorrect:**
```csharp
var client = new HttpClient(); // Causes socket exhaustion
```

**✅ Correct:**
```csharp
// Configure in Program.cs
builder.Services.AddTraceableHttpClient("ExternalApi", client =>
{
    client.BaseAddress = new Uri("https://api.example.com/");
});

// Use in service
var client = _httpClientFactory.CreateClient("ExternalApi");
```

## FAQ

### Q: Can I use correlation-id in console applications?

A: Yes! Use `CorrelationContext.GetOrCreate()` to manually generate a correlation-id.

### Q: Is correlation-id preserved in Task.Run()?

A: No. `Task.Run()` creates a new isolated asynchronous context. Use `await` to preserve the context.

### Q: Can I customize the header name?

A: Yes, use `TraceabilityOptions.HeaderName` to define a custom name.

### Q: How to disable auto-registration of middleware?

A: Set `AutoRegisterMiddleware = false` in options and register manually with `app.UseCorrelationId()`.

### Q: Are logs always in JSON?

A: Yes, all logs generated by Traceability are always in JSON format to ensure uniformity.

## Still having problems?

If you're still experiencing issues:

1. Check the [Technical Documentation](../AGENTS.md) to understand the internal architecture
2. See the [Examples](examples/aspnet-core.md) for working implementations
3. Open an issue in the project repository
