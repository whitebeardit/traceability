# Lesson 10: Troubleshooting

In this lesson, you'll learn to resolve common problems when using Traceability.

## Correlation-id is not being propagated

### Problem

The correlation-id doesn't appear in HTTP calls or logs.

### Solutions

1. **Check if middleware is configured:**
   ```csharp
   // Make sure AddTraceability() was called
   builder.Services.AddTraceability("UserService");
   ```

2. **Check if HttpClient is using CorrelationIdHandler:**
   ```csharp
   // Use AddTraceableHttpClient or add handler manually
   builder.Services.AddTraceableHttpClient("ExternalApi", client =>
   {
       client.BaseAddress = new Uri("https://api.example.com/");
   });
   ```

3. **Check if AutoConfigureHttpClient is not disabled:**
   ```csharp
   builder.Services.AddTraceability("UserService", options =>
   {
       options.AutoConfigureHttpClient = true; // Should be true (default)
   });
   ```

## Correlation-id does not appear in logs

### For Serilog

**Solution:**
```csharp
Log.Logger = new LoggerConfiguration()
    .WithTraceability("UserService") // Add this line
    .WriteTo.Console(
        outputTemplate: "[{Timestamp:HH:mm:ss} {Level:u3}] {Source} {CorrelationId} {Message:lj}")
    .CreateLogger();
```

### For Microsoft.Extensions.Logging

**Solution:**
```csharp
builder.Services.AddTraceability("UserService");
builder.Logging.AddConsole(options => options.IncludeScopes = true); // Enable scopes
```

## Source is not being defined

### Error: InvalidOperationException

If you receive an exception stating that Source must be provided:

**Solution 1: Provide Source explicitly**
```csharp
builder.Services.AddTraceability("UserService");
```

**Solution 2: Set environment variable**
```bash
export TRACEABILITY_SERVICENAME="UserService"
```

**Solution 3: Configure in options**
```csharp
builder.Services.AddTraceability(options =>
{
    options.Source = "UserService";
});
```

## Problems with .NET Framework 4.8

### Web API - Handler doesn't work

**Solution:**
```csharp
// Make sure handler is in Global.asax.cs
GlobalConfiguration.Configure(config =>
{
    config.MessageHandlers.Add(new CorrelationIdMessageHandler());
    config.MapHttpAttributeRoutes();
});
```

### Traditional ASP.NET - Module doesn't work

**Solution:**
```xml
<!-- Make sure module is in web.config -->
<system.webServer>
  <modules>
    <add name="CorrelationIdHttpModule" 
         type="Traceability.Middleware.CorrelationIdHttpModule, Traceability" />
  </modules>
</system.webServer>
```

## HttpClient causing socket exhaustion

### Problem

Many HTTP connections are created without reuse.

### Solution

**❌ Incorrect:**
```csharp
var client = new HttpClient(); // Causes socket exhaustion
```

**✅ Correct:**
```csharp
// Configure in Program.cs
builder.Services.AddTraceableHttpClient("ExternalApi", client =>
{
    client.BaseAddress = new Uri("https://api.example.com/");
});

// Use in service
var client = _httpClientFactory.CreateClient("ExternalApi");
```

## Correlation-id not preserved in Task.Run()

### Problem

The correlation-id is not preserved when you use `Task.Run()`.

### Explanation

`Task.Run()` creates a new isolated asynchronous context. The correlation-id is not automatically preserved.

### Solution

Use `await` instead of `Task.Run()` when possible:

**❌ Incorrect:**
```csharp
Task.Run(() =>
{
    var id = CorrelationContext.Current; // May be different or null
});
```

**✅ Correct:**
```csharp
await ProcessAsync(); // Preserves context

async Task ProcessAsync()
{
    var id = CorrelationContext.Current; // Preserved
}
```

## FAQ

### Q: Can I use correlation-id in console applications?

A: Yes! Use `CorrelationContext.GetOrCreate()` to manually generate a correlation-id.

### Q: Is correlation-id preserved in Task.Run()?

A: No. `Task.Run()` creates a new isolated asynchronous context. Use `await` to preserve the context.

### Q: Can I customize the header name?

A: Yes, use `TraceabilityOptions.HeaderName` to define a custom name.

### Q: How to disable middleware auto-registration?

A: Set `AutoRegisterMiddleware = false` in options and register manually with `app.UseCorrelationId()`.

### Q: Are logs always in JSON?

A: Yes, all logs generated by Traceability are always in JSON format to ensure uniformity.

## Still having problems?

If you're still experiencing issues:

1. Check the [Technical Documentation](../../AGENTS.md) to understand the internal architecture
2. See the [Examples](../examples/aspnet-core.md) for working implementations
3. Open an issue in the project repository

## Congratulations!

You've completed the user manual! Now you know:

- ✅ What Traceability is and when to use it
- ✅ How to configure and use the package
- ✅ How to integrate with logging and HttpClient
- ✅ How to configure advanced options
- ✅ How to resolve common problems

Continue exploring:
- [Complete Documentation](../index.md)
- [Practical Examples](../examples/aspnet-core.md)
- [API Reference](../api-reference.md)
